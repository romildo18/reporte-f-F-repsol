<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Informe de Solicitudes de Tarjeta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f6f9; color:#333;}
    header { background:#1f2a44; color:#fff; padding:24px;}
    section { padding:24px;}
    h2 { margin-top:40px;}
    .cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px;}
    .card { background:#fff; padding:16px; border-radius:6px; box-shadow:0 2px 4px rgba(0,0,0,.1);}
    canvas { background:#fff; padding:16px; border-radius:6px; max-width:650px;}
  </style>
</head>

<body>

<header>
  <h1>Informe de Solicitudes de Tarjeta</h1>
  <p>Fecha de generación: <span id="fecha"></span></p>
</header>

<section>
  <h2>Resumen Ejecutivo</h2>
  <p id="resumen">Cargando datos...</p>
</section>

<section>
  <h2>Métricas por Grupo (1 y 2)</h2>
  <div class="cards" id="metricasGrupo"></div>
</section>

<section>
  <h2>Métricas por Tipo de Tarjeta</h2>
  <div class="cards" id="metricasTipo"></div>
</section>

<section>
  <h2>Distribución General de Resultados</h2>
  <canvas id="graficoPie"></canvas>
</section>

<section>
  <h2>Altas Diarias</h2>
  <canvas id="graficoDiario"></canvas>
</section>

<script>
document.getElementById("fecha").innerText = new Date().toLocaleDateString();

/* ===== CSV PARSER (;) ===== */
function parseCSV(text){
  const lines = text.trim().split("\n");
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const parts = lines[i].split(";");
    while(parts.length < 6) parts.push("");
    rows.push(parts);
  }
  return rows;
}

/* ===== LIMPIAR MONTO ===== */
function limpiarMonto(v){
  if(!v) return 0;
  return Number(v.replace("€","").replace(/\./g,"").replace(",",".").trim()) || 0;
}

/* ===== NORMALIZAR RESULTADO ===== */
function normalizarResultado(v){
  const t = (v||"").toLowerCase();
  if(t.includes("aprob")) return "Aprobado";
  if(t.includes("deneg")) return "Denegado";
  return "Sin información";
}

fetch("data.csv")
.then(r=>r.text())
.then(text=>{
  const rows = parseCSV(text);

  const data = rows.map(c=>{
    let fechaNormalizada = null;
    if(c[3]){
      const [m,d,y] = c[3].split("/");
      if(y) fechaNormalizada = `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    }

    return {
      resultado: normalizarResultado(c[1]),
      limite: limpiarMonto(c[2]),
      fecha: fechaNormalizada,
      grupo: (c[4]||"").trim(),
      tipo: (c[5]||"").trim()
    };
  });

  /* ===== PIE (TODOS LOS REGISTROS) ===== */
  const pie = {Aprobado:0, Denegado:0, "Sin información":0};
  data.forEach(d=>pie[d.resultado]++);

  new Chart(graficoPie,{
    type:"pie",
    data:{labels:Object.keys(pie), datasets:[{data:Object.values(pie)}]}
  });

  /* ===== ALTAS DIARIAS (SOLO CON FECHA) ===== */
  const dias = {};
  data.filter(d=>d.fecha).forEach(d=>{
    dias[d.fecha]=(dias[d.fecha]||0)+1;
  });
  const diasOrd = Object.keys(dias).sort();

  new Chart(graficoDiario,{
    type:"bar",
    data:{labels:diasOrd, datasets:[{label:"Solicitudes", data:diasOrd.map(f=>dias[f])}]}
  });

  /* ===== MÉTRICAS POR GRUPO ===== */
  const mg = document.getElementById("metricasGrupo");
  ["1","2"].forEach(g=>{
    const s = data.filter(d=>d.grupo===g);
    const a = s.filter(d=>d.resultado==="Aprobado");
    const d = s.filter(d=>d.resultado==="Denegado");
    const aLim = a.filter(x=>x.limite>0);

    const pct = (a.length+d.length)>0 ? Math.round(a.length/(a.length+d.length)*100) : 0;
    const lim = aLim.length ? Math.round(aLim.reduce((x,y)=>x+y.limite,0)/aLim.length) : 0;

    mg.innerHTML+=`
      <div class="card">
        <h3>Grupo ${g}</h3>
        <p>Solicitudes: ${s.length}</p>
        <p>Aprobados: ${a.length}</p>
        <p>Denegados: ${d.length}</p>
        <p>% Aprobación: ${pct}%</p>
        <p>Límite medio: ${lim} €</p>
      </div>`;
  });

  /* ===== MÉTRICAS POR TIPO ===== */
  const mt = document.getElementById("metricasTipo");
  ["Particular","Autónomo"].forEach(t=>{
    const s = data.filter(d=>d.tipo===t);
    const a = s.filter(d=>d.resultado==="Aprobado");
    const d = s.filter(d=>d.resultado==="Denegado");
    const pct = (a.length+d.length)>0 ? Math.round(a.length/(a.length+d.length)*100) : 0;

    mt.innerHTML+=`
      <div class="card">
        <h3>${t}</h3>
        <p>Solicitudes: ${s.length}</p>
        <p>Aprobados: ${a.length}</p>
        <p>Denegados: ${d.length}</p>
        <p>% Aprobación: ${pct}%</p>
      </div>`;
  });

  /* ===== RESUMEN ===== */
  const totalA = data.filter(d=>d.resultado==="Aprobado").length;
  const totalD = data.filter(d=>d.resultado==="Denegado").length;

  document.getElementById("resumen").innerText =
    `Se analizaron ${data.length} solicitudes. La tasa global de aprobación es del ${
      (totalA+totalD)>0 ? Math.round(totalA/(totalA+totalD)*100) : 0
    }%.`;
});
</script>

</body>
</html>
