<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Informe de Solicitudes de Tarjeta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f6f9;
      color: #333;
    }

    header {
      background: #1f2a44;
      color: white;
      padding: 24px;
    }

    section {
      padding: 24px;
    }

    h2 {
      margin-top: 40px;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }

    .card {
      background: white;
      padding: 16px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    canvas {
      background: white;
      padding: 16px;
      border-radius: 6px;
      max-width: 650px;
    }

    .error {
      color: #b00020;
      font-weight: bold;
    }
  </style>
</head>

<body>

<header>
  <h1>Informe de Solicitudes de Tarjeta</h1>
  <p>Fecha de generación: <span id="fecha"></span></p>
</header>

<section>
  <h2>Resumen Ejecutivo</h2>
  <p id="resumen">Cargando datos...</p>
</section>

<section>
  <h2>Métricas por Grupo (1 y 2)</h2>
  <div class="cards" id="metricasGrupo"></div>
</section>

<section>
  <h2>Métricas por Tipo de Tarjeta</h2>
  <div class="cards" id="metricasTipo"></div>
</section>

<section>
  <h2>Distribución General de Resultados</h2>
  <canvas id="graficoPie"></canvas>
</section>

<section>
  <h2>Altas Diarias</h2>
  <canvas id="graficoDiario"></canvas>
</section>

<script>
/* =======================
   FECHA ACTUAL
   ======================= */
document.getElementById("fecha").innerText =
  new Date().toLocaleDateString();

/* =======================
   CSV PARSER ROBUSTO
   DETECTA ; O ,
   ======================= */
function parseCSV(text) {
  const lines = text.trim().split("\n");
  if (lines.length < 2) return [];

  const delimiter = lines[0].includes(";") ? ";" : ",";
  const rows = [];

  for (let i = 1; i < lines.length; i++) {
    const line = lines[i];
    const values = [];
    let current = "";
    let insideQuotes = false;

    for (let char of line) {
      if (char === '"') {
        insideQuotes = !insideQuotes;
      } else if (char === delimiter && !insideQuotes) {
        values.push(current);
        current = "";
      } else {
        current += char;
      }
    }
    values.push(current);
    rows.push(values);
  }
  return rows;
}

/* =======================
   CARGA DE DATOS
   ======================= */
fetch("data.csv")
  .then(res => res.text())
  .then(text => {
    const rows = parseCSV(text);

    const data = rows
      .filter(r => r.length >= 6)
      .map(c => {
        const [mes, dia, anio] = c[3].split("/");
        const fechaNormalizada =
          `${anio}-${mes.padStart(2,"0")}-${dia.padStart(2,"0")}`;

        return {
          resultado: c[1]?.trim(),
          limite: parseFloat(c[2]) || 0,
          fecha: fechaNormalizada,
          grupo: c[4]?.trim(),
          tipo: c[5]?.trim()
        };
      });

    /* =======================
       PIE CHART
       ======================= */
    const resultadosCount = {
      Aprobado: 0,
      Negado: 0,
      "Sin información": 0
    };

    data.forEach(d => {
      if (resultadosCount[d.resultado] !== undefined) {
        resultadosCount[d.resultado]++;
      }
    });

    new Chart(document.getElementById("graficoPie"), {
      type: "pie",
      data: {
        labels: Object.keys(resultadosCount),
        datasets: [{
          data: Object.values(resultadosCount)
        }]
      }
    });

    /* =======================
       ALTAS DIARIAS
       ======================= */
    const fechas = {};
    data.forEach(d => {
      fechas[d.fecha] = (fechas[d.fecha] || 0) + 1;
    });

    const fechasOrdenadas = Object.keys(fechas).sort();

    new Chart(document.getElementById("graficoDiario"), {
      type: "bar",
      data: {
        labels: fechasOrdenadas,
        datasets: [{
          label: "Solicitudes",
          data: fechasOrdenadas.map(f => fechas[f])
        }]
      }
    });

    /* =======================
       MÉTRICAS POR GRUPO
       ======================= */
    const contGrupo = document.getElementById("metricasGrupo");
    ["1","2"].forEach(g => {
      const subset = data.filter(d => d.grupo === g);
      const aprobados = subset.filter(d => d.resultado === "Aprobado");
      const denegados = subset.filter(d => d.resultado === "Negado");

      const limiteMedio =
        aprobados.reduce((a,b) => a + b.limite, 0) /
        (aprobados.length || 1);

      contGrupo.innerHTML += `
        <div class="card">
          <h3>Grupo ${g}</h3>
          <p>Solicitudes: ${subset.length}</p>
          <p>Aprobados: ${aprobados.length}</p>
          <p>Denegados: ${denegados.length}</p>
          <p>% Aprobación:
            ${Math.round((aprobados.length / (subset.length || 1)) * 100)}%
          </p>
          <p>Límite medio otorgado:
            ${limiteMedio.toFixed(0)}
          </p>
        </div>`;
    });

    /* =======================
       MÉTRICAS POR TIPO
       ======================= */
    const contTipo = document.getElementById("metricasTipo");
    ["Particular","Autónomo"].forEach(t => {
      const subset = data.filter(d => d.tipo === t);
      const aprobados = subset.filter(d => d.resultado === "Aprobado");
      const denegados = subset.filter(d => d.resultado === "Negado");

      contTipo.innerHTML += `
        <div class="card">
          <h3>${t}</h3>
          <p>Solicitudes: ${subset.length}</p>
          <p>Aprobados: ${aprobados.length}</p>
          <p>Denegados: ${denegados.length}</p>
          <p>% Aprobación:
            ${Math.round((aprobados.length / (subset.length || 1)) * 100)}%
          </p>
        </div>`;
    });

    /* =======================
       RESUMEN EJECUTIVO
       ======================= */
    document.getElementById("resumen").innerText =
      `Se analizaron ${data.length} solicitudes.
       La tasa global de aprobación es
       ${Math.round((resultadosCount["Aprobado"] / data.length) * 100)}%.`;

  })
  .catch(err => {
    document.getElementById("resumen").innerHTML =
      '<span class="error">Error cargando los datos. Revisa el archivo data.csv.</span>';
    console.error(err);
  });
</script>

</body>
</html>
